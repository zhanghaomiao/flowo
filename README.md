# Flowo 🚀

Welcome to **Flowo** – your modern, real-time workflow dashboard!

Unleash the power of automation and monitoring with a fresh, interactive experience.

---

## ✨ Features

- ⚡ **Real-time Monitoring:**
  Flowo uses Server-Sent Events (SSE) and PostgreSQL's LISTEN/NOTIFY mechanism for instant workflow updates. The frontend refreshes automatically – just sit back and watch the magic happen!

<<<<<<< HEAD
- 🚀 **Efficient Data Fetching:**
  With smart polling (every 5 seconds) and debouncing, Flowo keeps your data up-to-date without overloading the network. Fast, efficient, and always fresh.
=======
1. **PostgreSQL Container** starts first and becomes healthy
2. **Alembic Migration Service** runs `alembic upgrade head` to create table schemas  
3. **Same Service** then executes `init-db/01-triggers-functions.sql` to create functions and triggers
4. **Application Services** (backend, monitor) start only after both migrations complete successfully
>>>>>>> ef59c4d1de0ba99f56739f01379cab7e024d8a2a

- 🔍 **Search & Filtering:**
  Find what you need in a snap! Search and filter workflows by name, tags, or user. Delete workflows from the database with a click (no worries, your files are safe).

- 🧩 **Rule-based Filtering:**
  Focus on specific rules to filter jobs and update the execution timeline. Debug and optimize like a pro!

- 🖼️ **Result Preview:**
  Instantly preview output files generated by your favorite rules, right in the Results submenu. No more hunting for results!

- 📋 **Logging System:**
  Dive into detailed workflow and job logs. Analyze, learn, and improve your processes with ease.

---

### 🛠️ Workflows
![Workflow](assets/images/workflow.png)

### 📊 Dashboard
![Dashboard](assets/images/dashboard.png)

### 🕹️ Jobs
| ![DAG](assets/images/dag.png) | ![Jobs](assets/images/jobs.png) |
|------------------------------|-------------------------------|

---

## 🚦 Installation
- **Requirement:** Docker

### 1. Download
```sh
git clone https://github.com/zhanghaomiao/flowo.git && cd flowo
cp env.example .env
```

<<<<<<< HEAD
### 2. Installation Option 1 (Recommended)
This method pulls pre-built images, so you don't need to build them yourself. Note: The PORT is fixed at 3100 and cannot be changed. Set DOMAIN to your server's IP or domain.

Edit your `.env` file as follows:
```sh
# Application Settings
DOMAIN=localhost
PORT=3100
TZ=Asia/Shanghai

=======
## Architecture Options

### Option 1: Separate Monitoring Service (Recommended)
**File**: `docker-compose.yml`

```bash
# Copy environment file
cp .env.example .env

# Start services
docker-compose up -d
```

**Services:**
- `postgresql`: PostgreSQL database server
- `snakemake-backend`: Main Snakemake application
- `db-monitor`: Dedicated monitoring service (lightweight Python container)

**Benefits:**
- Clear separation of concerns
- Independent scaling and restart policies
- Lightweight monitoring container
- Easy to disable monitoring if needed

### Option 2: Integrated Monitoring (Alternative)
**File**: `docker-compose.integrated.yml`

```bash
# Start with integrated monitoring
docker-compose -f docker-compose.integrated.yml up -d
```

**Services:**
- `postgresql`: PostgreSQL database server
- `snakemake-backend`: Combined application and monitoring service

**Benefits:**
- Fewer containers to manage
- Shared resources and logs
- Simpler networking

## Environment Configuration

Create a `.env` file with the following variables:

```env
>>>>>>> ef59c4d1de0ba99f56739f01379cab7e024d8a2a
# Database Configuration
POSTGRES_DB=snakemake_logs
POSTGRES_USER=snakemake
POSTGRES_PASSWORD=snakemake_password
POSTGRES_HOST=localhost
POSTGRES_PORT=5432

<<<<<<< HEAD
# Workflow Directory
FLOWO_WORKING_PATH=/path/to/flowo_project_dir
```

To start Flowo:
```sh
docker compose -f docker-compose.release.yml up -d
```

Open http://localhost:3100 in your browser. If you changed DOMAIN, open http://yourdomain:3100 instead.

### 3. Installation Option 2 (Custom Build)
This method builds the images locally, allowing you to customize the PORT.

Edit your `.env` file as follows:
```sh
# Application Settings
DOMAIN=localhost
PORT=your_port
TZ=Asia/Shanghai

# Database Configuration
POSTGRES_DB=snakemake_logs
POSTGRES_USER=snakemake
POSTGRES_PASSWORD=snakemake_password
POSTGRES_HOST=localhost
POSTGRES_PORT=5432

# Workflow Directory
FLOWO_WORKING_PATH=/path/to/flowo_project_dir
```

To start Flowo:
```sh
docker compose -f docker-compose.yml up -d
```

Open http://localhost:your_port in your browser.
=======
# Application Configuration
REPO_PATH=./
BACKEND_PORT=8000
SNAKEMAKE_CORES=4
LOG_LEVEL=INFO

# Monitoring (for integrated setup)
ENABLE_DB_MONITORING=true
```

## Database Monitoring Features

### Automatic Change Detection
The setup includes PostgreSQL triggers and functions that automatically:
- Log all INSERT, UPDATE, DELETE operations
- Send real-time notifications via PostgreSQL LISTEN/NOTIFY
- Track which specific fields changed
- Store change history in `change_notifications` table

### Monitoring Methods

1. **Real-time Notifications**: Uses PostgreSQL LISTEN/NOTIFY for instant change detection
2. **Polling**: Checks for unprocessed notifications every 10 seconds
3. **Change History**: Full audit trail of all database changes

### Database Schema

The system creates these main tables:
- `workflow_runs`: Snakemake workflow execution records
- `job_executions`: Individual job/rule execution records  
- `log_entries`: Detailed log messages
- `change_notifications`: Audit trail of all changes

## Usage Examples

### Start the Full Setup
```bash
# Copy example environment
cp .env.example .env

# Edit .env with your configuration
nano .env

# Start services
docker-compose up -d

# View logs
docker-compose logs -f
```

### Monitor Database Changes
```bash
# View monitoring logs
docker-compose logs -f db-monitor

# Connect to database directly
docker-compose exec postgresql psql -U snakemake -d snakemake_logs

# Query recent changes
SELECT * FROM get_recent_changes('2024-01-01'::timestamp);
```

### Testing the Triggers

Connect to the database and insert test data:

```sql
-- Connect to database
docker-compose exec postgresql psql -U snakemake -d snakemake_logs

-- Insert a test workflow
INSERT INTO workflow_runs (workflow_name, status) 
VALUES ('test_workflow', 'running');

-- Check notifications were created
SELECT * FROM change_notifications ORDER BY timestamp DESC LIMIT 5;
```

## Container Size Comparison

| Container Type | Base Image | Size | Purpose |
|---------------|------------|------|---------|
| Original (❌) | postgres:15-alpine | ~280MB | Full PostgreSQL server for monitoring |
| Improved (✅) | python:3.12-alpine | ~150MB | Only PostgreSQL client tools |
| Integrated (✅) | python:3.12-slim | ~200MB | Combined app + monitoring |

## Why the Original Design Was Problematic

The initial setup used `postgres:15-alpine` for both database and monitoring services:

```yaml
# ❌ Problematic - both use same heavy image
postgresql:
  image: postgres:15-alpine  # ~280MB, runs PostgreSQL server
  
db-monitor:
  image: postgres:15-alpine  # ~280MB, only needs psql client
```

**Issues:**
1. **Resource waste**: Monitoring container loads full PostgreSQL server
2. **Security**: Unnecessary services running in monitoring container
3. **Confusion**: Same image for different purposes
4. **Maintenance**: Harder to optimize containers independently

## Improved Solutions

### Solution 1: Lightweight Monitoring Container
```yaml
# ✅ Better - dedicated lightweight monitoring
db-monitor:
  build:
    dockerfile: Dockerfile.monitor  # python:3.12-alpine + psql client
```

### Solution 2: Integrated Services
```yaml
# ✅ Alternative - single container with supervisor
snakemake-backend:
  build:
    dockerfile: Dockerfile.integrated  # Combined app + monitoring
```

## Security Considerations

- Change default passwords in production
- Use Docker secrets for sensitive data
- Limit network exposure of PostgreSQL port
- Enable PostgreSQL SSL in production
- Regular backup of persistent volumes

## Troubleshooting

### Common Issues

1. **Permission denied on monitoring scripts**:
   ```bash
   chmod +x monitor/*.sh monitor/*.py
   ```

2. **Database connection errors**:
   ```bash
   # Check if PostgreSQL is ready
   docker-compose exec postgresql pg_isready
   ```

3. **Monitoring not working**:
   ```bash
   # Check if triggers are installed
   docker-compose exec postgresql psql -U snakemake -d snakemake_logs \
     -c "SELECT tgname FROM pg_trigger WHERE tgname LIKE '%notify%';"
   ```

### Logs Location

- Application logs: `./logs/`
- Database logs: Available via `docker-compose logs postgresql`
- Monitoring logs: Available via `docker-compose logs db-monitor`

## Development

To extend the monitoring functionality:
>>>>>>> ef59c4d1de0ba99f56739f01379cab7e024d8a2a


